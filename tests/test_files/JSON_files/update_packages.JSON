[[],["=","fieldorder",["c","\"Package\"","\"Version\"","\"Priority\"","\"Depends\"","\"Imports\"","\"LinkingTo\"","\"Suggests\"","\"Enhances\"","\"License\"","\"License_is_FOSS\"","\"License_restricts_use\"","\"OS_type\"","\"Archs\"","\"MD5sum\"","\"NeedsCompilation\"","\"File\"","\"Repository\""]],["<-","update_PACKAGES",["function",[{"dir":"\".\"","fields":"NULL","type":["c","\"source\"","\"mac.binary\"","\"win.binary\""],"verbose.level":["as.integer","dryrun"],"latestOnly":"TRUE","addFiles":"FALSE","rds_compress":"\"xz\"","strict":"TRUE","dryrun":"FALSE"}],["{",["if",["!",["is.integer","verbose.level"]],["=","verbose.level",["as.integer","verbose.level"]]],["<-","type",["match.arg","type"]],["stopifnot",["&&",[">=","verbose.level","0L"],["<=","verbose.level","2L"]]],["<-","PKGSfile",["file.path","dir","\"PACKAGES\""]],["<-","calldown","FALSE"],["<-","retdat","NULL"],["if",["&&",["==","type","\"win.binary\""],"strict"],["{",["warning","\"PACKAGES files do not include MD5 sums in the win.binary case\"","\", so strict checking is impossible. Calling down to write_PACKAGES \"","\"directly.\""],["<-","calldown","TRUE"]],["if",["!",["file.exists","PKGSfile"]],["{",["warning","\"No existing PACKAGES file found at \"","PKGSfile"],["<-","calldown","TRUE"]],["if",["!",["all",[">",["dim",["<-","retdat",["as.data.frame",["read.dcf","PKGSfile"],{"stringsAsFactors":"FALSE"}]]],"0L"]]],["{",["warning","\"Existing PACKAGES file contained no rows and/or no columns\""],["<-","calldown","TRUE"]]]]],["<-","okfields",["names","retdat"]],["if",["&&",["&&",["!","calldown"],["!",["is.null","fields"]]],["!",["all",["%in%","fields","okfields"]]]],["{",["warning","\"Specified fields no present in existing PACKAGES file: \"",["paste",["setdiff","fields","okfields"],{"collapse":"\" \""}]],["<-","calldown","TRUE"]]],["if","calldown",["{",["if",[">","verbose.level","0L"],["message","\"Unable to update existing PACKAGES file. Calling write_PACKAGES directly.\""]],["return",["write_PACKAGES",{"dir":"dir"},{"fields":"fields"},{"type":"type"},{"verbose":["==","verbose.level","2"]},{"latestOnly":"latestOnly"},{"addFiles":"addFiles"},{"rds_compress":"rds_compress"}]]]],["<-","pmtime",["$",["file.info","PKGSfile"],"mtime"]],["if",[">","verbose.level","0L"],["{",["message","\"Updating existing repository [strict mode: \"",["if","strict","\"ON\"","\"OFF\""],"\"]\\nDetected PACKAGES file with \"",["nrow","retdat"],"\" entries at \"","PKGSfile"]]],["if",["!",["is.null","fields"]],["<-","retdat",["[","retdat",{},"fields"]]],["<-","pkgfiles",["list.files","dir",{"pattern":[".get_pkg_file_pattern","type"]},{"full.names":"TRUE"}]],["if",["==",["length","pkgfiles"],"0L"],["stop","\"unable to find any package tarballs in \"","dir"]],["if",["is.null",["$","retdat","File"]],["{",["<-","tbmatches",["match",["paste",["$","retdat","Package"],["$","retdat","Version"],{"sep":"\"_\""}],["gsub",[".get_pkg_file_pattern","type",{"ext.only":"TRUE"}],"\"\"",["basename","pkgfiles"]]]],["<-",["$","retdat","tarball"],["[","pkgfiles","tbmatches"]]],["<-",["$","retdat","tarball"],["$","retdat","File"]]],["=",["$","retdat","IsNew"],"FALSE"],["<-","keeprows",["file.exists",["$","retdat","tarball"]]],["if",[">","verbose.level","0L"],["{",["<-","msg",["paste","\"Tarballs found for\"",["sum","keeprows"],"\" of \"",["nrow","retdat"],"\"existing PACKAGES entries.\""]],["message","msg"]]],["<-","retdat",["[","retdat","keeprows",{}]],["<-","tbmtimes",["$",["file.info",["$","retdat","tarball"]],"mtime"]],["<-","toonew",["which",[">","tbmtimes","pmtime"]]],["if",[">",["length","toonew"],"0L"],["{",["if",[">","verbose.level","0L"],["{",["<-","msg",["paste",["length","toonew"],"\" tarball(s) matching existing entries are \"","\"newer than PACKAGES file and must be reprocessed.\""]],["message","msg"]]],["<-","retdat",["[","retdat",["-","toonew"],{}]]]],["if",["&&","strict",[">",["NROW","retdat"],"0L"]],["{",["if",[">","verbose.level","0L"],["{",["<-","msg",["paste","\"[strict mode] Checking if MD5sums match \"","\"for existing tarballs\""]],["message","msg"]]],["<-","curMD5sums",["md5sum",["normalizePath",["$","retdat","tarball"]]]],["<-","notokinds",["which",["!=",["$","retdat","MD5sum"],"curMD5sums"]]],["if",[">",["length","notokinds"],"0L"],["{",["<-","msg",["paste0","\"Detected \"",["length","notokinds"],"\" MD5sum mismatches\"","\" between existing PACKAGES file and tarballs\""]],["warning","msg"]],["if",[">","verbose.level","0L"],["{",["message","\"All existing entry MD5sums match tarballs.\""]]]],["if",[">",["length","notokinds"],"0L"],["{",["<-","retdat",["[","retdat",["-","notokinds"],{}]]]]]],["<-","newpkgfiles",["setdiff",["normalizePath","pkgfiles"],["normalizePath",["$","retdat","tarball"]]]],["if",["&&",["&&",["!","strict"],"latestOnly"],[">",["length","newpkgfiles"],"0L"]],["{",["<-","newpkgtmp",["gsub",[".get_pkg_file_pattern","type",{"ext.only":"TRUE"}],"\"\"",["basename","newpkgfiles"]]],["<-","newpkgspl",["strsplit",["basename","newpkgtmp"],"\"_\""]],["<-","newpkgdf",["do.call","rbind.data.frame",["c","newpkgspl",{"stringsAsFactors":"FALSE"}]]],["<-","newpkgdf",["[","newpkgdf",{},[":","1","2"]]],["<-",["names","newpkgdf"],["c","\"Package\"","\"Version\""]],["<-","newpkgdf",[".filldfcols","newpkgdf","retdat"]],["<-",["$","newpkgdf","IsNew"],"TRUE"],["<-",["$","newpkgdf","tarball"],"newpkgfiles"],["<-","retdat",["rbind","retdat","newpkgdf"]],["<-","retdat",[".remove_stale_dups","retdat"]],["<-","newpkgfiles",["[",["$","retdat","tarball"],["$","retdat","IsNew"]]]]],["<-","numnew",["length","newpkgfiles"]],["if",[">","numnew","0L"],["{",["if",[">","verbose.level","0L"],["{",["message","\"Found \"","numnew","\" package versions to process.\""]]],["<-","newpkgdat",[".process_package_files_for_repository_db","newpkgfiles","type","fields",[">","verbose.level","1"]]],["<-","newpkgdat",[".process_repository_package_db_to_matrix","newpkgdat",{"path":"\"\""},"addFiles",{"addPaths":"FALSE"},"latestOnly"]],["<-","newpkgdf",["as.data.frame","newpkgdat",{"stringsAsFactors":"FALSE"}]],["if",["!",["identical",["names","newpkgdf"],["names","retdat"]]],["{",["<-","newpkgdf",[".filldfcols","newpkgdf","retdat"]],["<-","retdat",[".filldfcols","retdat","newpkgdf"]]]],["if",[">","verbose.level","0L"],["{",["<-","msg",["paste","\"Processed\"",["nrow","newpkgdf"],"\"entries from \"","\"package tarballs.\""]],["message","msg"]]],["<-",["$","newpkgdf","IsNew"],"TRUE"],["<-","retdat",["rbind",["[","retdat",["!",["$","retdat","IsNew"]],{}],"newpkgdf"]],["if","latestOnly",["{",["<-","retdat",[".remove_stale_dups","retdat"]]]],["if",[">","verbose.level","0L"],["{",["<-","msg",["paste",["sum",["$","retdat","IsNew"]],"\"entries added or updated, \"",["sum",["!",["$","retdat","IsNew"]]],"\" entries retained unchanged.\""]],["message","msg"]]]],["if",[">","verbose.level","0L"],["{",["message","\"No new packages or updated package versions detected\""]]]],["if",[">","verbose.level","0L"],["{",["<-","msg",["paste","\"Final updated PACKAGES db contains \"",["nrow","retdat"],"\" entries.\""]],["message","msg"]]],["<-","retdat",["[","retdat",["order",["paste0",["$","retdat","Package"],["$","retdat","Version"]]],{}]],["<-",["$","retdat","IsNew"],"NULL"],["<-",["$","retdat","tarball"],"NULL"],["<-","noncanonfs",["setdiff",["names","retdat"],"fieldorder"]],["<-","canonfs",["[","fieldorder",["%in%","fieldorder",["names","retdat"]]]],["<-","retdat",["[","retdat",{},["c","canonfs","noncanonfs"]]],["if","dryrun",["{",["if",[">","verbose.level","0L"],["message","\"[dryrun mode] Dryrun complete.\""]]],["{",["if",[">","verbose.level","0L"],["message","\"Writing final updated PACKAGES files.\""]],["<-","db",["as.matrix","retdat"]],["<-","np",[".write_repository_package_db","db","dir","rds_compress"]],["if",[">","verbose.level","0L"],["message","\"update_PACKAGES complete.\""]]]]]]],["<-",".filldfcols",["function",[{"df":"","srcdf":""}],["{",["<-","srcnames",["names","srcdf"]],["<-","dfnames",["names","df"]],["<-","newcols",["setdiff","srcnames","dfnames"]],["<-",["[","df",{},"newcols"],["[","srcdf",["integer",{}],"newcols"]],["<-","df",["[","df",{},["unique",["c","srcnames","dfnames"]]]],"df"]]]]
